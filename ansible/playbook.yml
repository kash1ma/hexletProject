---
- name: Deploy Laravel application to Yandex Cloud
  hosts: 51.250.111.163
  become: yes
  tasks:
    - name: Update apt cache
      apt:
        update_cache: yes

    - name: Install dependencies
      apt:
        name: "{{ item }}"
        state: present
      loop:
        - curl
        - sqlite3
        - php8.3
        - php8.3-sqlite3
        - php8.3-xml
        - apache2

    - name: Install Docker
      apt:
        name: docker.io
        state: present

    - name: Install Docker Compose
      apt:
        name: docker-compose
        state: present

    - name: Ensure Docker service is running
      service:
        name: docker
        state: started
        enabled: yes

    - name: Stop Apache
      service:
        name: apache2
        state: stopped

    - name: Clone the repository
      git:
        repo: "https://github.com/kash1ma/hexletProject"
        dest: /home/h4t0rihanzo/hexletProject/
        version: master

    - name: Build Docker
      command: docker build -t user-crud-app /home/h4t0rihanzo/hexletProject

    - name: Run the Docker container
      docker_container:
        name: user-crud-app
        image: user-crud-app
        state: started
        restart_policy: always
        ports:
          - "80:80"

    - name: Ensure Apache is running on port 8080
      copy:
        dest: /etc/apache2/ports.conf
        content: |
          Listen 8080
      notify:
        - Restart Apache

    - name: Create Apache config
      copy:
        dest: /etc/apache2/sites-available/hexletJob.conf
        content: |
          <VirtualHost *:8080>
              ServerName 51.250.111.163
              DocumentRoot /home/h4t0rihanzo/hexletProject/public
              <Directory /home/h4t0rihanzo/hexletProject/public>
                  Options Indexes FollowSymLinks
                  AllowOverride All
                  Require all granted
              </Directory>
              ErrorLog ${APACHE_LOG_DIR}/error.log
              CustomLog ${APACHE_LOG_DIR}/access.log combined
          </VirtualHost>
      notify:
        - Restart Apache

    - name: Enable Apache site
      command: a2ensite hexletJob
      notify:
        - Restart Apache

    - name: Enable Apache rewrite module
      command: a2enmod rewrite
      notify:
        - Restart Apache

  handlers:
    - name: Restart Apache
      service:
        name: apache2
        state: restarted
